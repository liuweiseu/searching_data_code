clear;
clc;
close all;

% add the path of psf_rw
addpath(genpath('../psf_rw'));

% include global parameters
PsrGlobals;

% get the full path of the psr file
[filename0, pathname] = uigetfile( ...
    {'*.pf','data Files';...
    '*.*','All Files' },...
    'Please select the PSR data file',...
    '/Users/wei/Project/PSR/data');
if isequal(filename0,0)
   disp('User selected Cancel')
   return;
else
   filename= fullfile(pathname, filename0);
end

[path,name,ext] = fileparts(filename);
fp = fopen(filename);

% get period
Period = fread(fp,1,'double');
% get dt
dt = fread(fp,1,'double');
% get obs start freq
ObsStartFreq = fread(fp,1,'double');
% get obs bandwidth
ObsBandwidth = fread(fp,1,'double');
% get channelnum/row num
row = fread(fp,1,'double');
% get column num
col = fread(fp,1,'double');
% get dm
dm = fread(fp,1,'double');
% skip the pf file header
fseek(fp,512,'bof');
% get pf_data
pf_data = fread(fp,[row, col],'double');

fclose(fp);

if(dm >= 0)
    offset_array = [];
else
    [filename0, pathname] = uigetfile( ...
    {'*.oa','data Files';...
    '*.*','All Files' },...
    'Please select the PSR data file',...
    '/Users/wei/Project/PSR/data');
if isequal(filename0,0)
   disp('User selected Cancel')
   return;
else
   oa_filename= fullfile(pathname, filename0);
end
   offset_array = load(oa_filename) 
end
pf_data_out = DeDispersion(pf_data,ObsStartFreq,ObsBandwidth,dm,period,offset_array);
    
